<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="edge"/>
    <title>用户成长系统</title>
    <link rel="shortcut icon" type="image/png" th:href="@{/images/favicon.ico}"/>
    <link rel="stylesheet" data-th-href="@{/css/bootstrap.min.css}"/>
    <link rel="stylesheet" data-th-href="@{/css/materialdesignicons.min.css}"/>
    <link rel="stylesheet" data-th-href="@{/css/animate.css}"/>
    <link rel="stylesheet" data-th-href="@{/plugins/confirm/jquery-confirm.min.css}">
    <link rel="stylesheet" data-th-href="@{/css/style.min.css}"/>
    <link rel="stylesheet" type="text/css"
          data-th-href="@{/plugins/bootstrap-year-calendar/css/bootstrap-year-calendar.min.css}">
    <link rel="stylesheet" data-th-href="@{/plugins/ztree/zTreeStyle.css}"/>

    <style>
        ul.ztree {margin-top: 0px;border: 1px solid #ccc;background: #ffffff;width:192px;height:260px;overflow-y:scroll;overflow-x:auto;}
    </style>
</head>

<body>
<!-- 公共组件 -->
<div data-th-include="common/common"></div>
<div class="lyear-layout-web">
    <div class="lyear-layout-container">
        <!-- 左侧导航 -->
        <div data-th-include="common/aside"></div>
        <!-- 头部信息 -->
        <div data-th-include="common/header"></div>
        <!-- 页面主要内容 -->
        <main class="lyear-layout-content" id="main">
            <div class="container-div ui-layout-center">
                <div class="row">
                    <div class="col-sm-12 search-collapse">
                        <div class="col-md-12">
                            <div class="row">
                                <h5 class="modal-title pull-left" style="margin-top: 20px;">用户成长洞察</h5>
                            </div>
                            <div class="row">
                                <hr class="hr"/>
                            </div>
                            <div class="row">
                                <form id="activity-form">
                                    <div class="select-list">
                                        <ul>
                                            <li>
                                                时间范围：
                                                <select id="dateRange" name="dateRange">
                                                    <option value="">请选择</option>
                                                    <option value="1">1个月</option>
                                                    <option value="3">3个月</option>
                                                    <option value="6">6个月</option>
                                                    <option value="12">12个月</option>
                                                </select>
                                            </li>
                                            <li class="pull-right">
                                                <a class="btn btn-primary btn-rounded btn-sm"
                                                   onclick="searchInsight()"><i class="fa fa-search"></i>&nbsp;搜索</a>
                                                <a class="btn btn-warning btn-rounded btn-sm" onclick="resetInsight()"><i
                                                        class="fa fa-refresh"></i>&nbsp;重置</a>
                                            </li>
                                        </ul>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-12 select-table table-striped">
                        <div class="row">
                            <div class="col-sm-12 table-striped">
                                <!--桑基图-->
                                <div class="row">
                                    <div class="col-md-12">
                                        <h5 class="modal-title pull-left" style="margin-top: 20px;">品牌用户成长旅程</h5>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <hr class="hr" style="margin-top: 5px;margin-bottom: 5px;"/>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-9">
                                        <table id="userCntTable" class="table table-striped"></table>
                                    </div>
                                </div>
                                <div class="row" style="margin-top: 12px;">
                                    <div class="col-md-12">
                                        <iframe src="/sankey?dateRange=1" width="100%" height="400px" frameborder="0" id="sankeyFrame"></iframe>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-12 select-table table-striped">
                        <div class="row">
                            <div class="col-md-12">
                                <h5 class="modal-title pull-left" style="margin-top: 20px;">成长旅程价值呈现</h5>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <hr class="hr" style="margin-top: 5px;margin-bottom: 5px;"/>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12 table-responsive">
                                <table id="spuValueTable" class="table table-striped text-nowrap"></table>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-12 select-table table-striped">
                        <div class="row">
                            <div class="col-md-12">
                                <h5 class="modal-title pull-left" style="margin-top: 20px;">选择旅程中重要SPU</h5>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <hr class="hr" style="margin-top: 5px;margin-bottom: 5px;"/>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <form>
                                    <div class="select-list">
                                        <ul>
                                            <li>
                                                SPU名称：<input type="text" name="spuName">
                                            </li>
                                            <li>
                                                购买次序：
                                                <select name="purchOrder">
                                                    <option value="">请选择</option>
                                                    <option value="1">1</option>
                                                    <option value="2">2</option>
                                                    <option value="3">3</option>
                                                    <option value="4">4</option>
                                                    <option value="5">5</option>
                                                    <option value="6">6</option>
                                                    <option value="7">7</option>
                                                    <option value="8">8</option>
                                                </select>
                                            </li>
                                            <li class="pull-right">
                                                <a class="btn btn-primary btn-rounded btn-sm"
                                                   onclick="searchImportSpu()"><i class="fa fa-search"></i>&nbsp;搜索</a>
                                                <a class="btn btn-warning btn-rounded btn-sm" onclick="resetImportSpu()"><i
                                                        class="fa fa-refresh"></i>&nbsp;重置</a>
                                            </li>
                                        </ul>
                                    </div>
                                </form>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <table class="table table-striped" id="importSpu"></table>
                            </div>
                        </div>
                    </div>

                    <!--SPU的用户成长模式-->
                    <div class="col-md-12 select-table table-striped">
                        <div class="row">
                            <div class="col-md-12">
                                <h5 class="modal-title pull-left" style="margin-top: 20px;">SPU的用户成长模式</h5>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <hr class="hr" style="margin-top: 5px;margin-bottom: 5px;"/>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <form>
                                    <div class="select-list">
                                        <ul>
                                            <li>
                                                SPU/商品：<input type="text" id="spuOrProductName"/>
                                                <div id="menuContent" hidden style="z-index: 100;position: absolute;">
                                                    <ul id="spuTree" class="ztree"></ul>
                                                </div>
                                                <input type="hidden" id="type"/>
                                                <input type="hidden" id="id"/>
                                            </li>
                                            <li>
                                                周期：
                                                <select name="period" id="period">
                                                    <option value="">请选择</option>
                                                    <option value="1">1</option>
                                                    <option value="2">2</option>
                                                    <option value="3">3</option>
                                                    <option value="4">4</option>
                                                    <option value="5">5</option>
                                                    <option value="6">6</option>
                                                    <option value="7">7</option>
                                                    <option value="8">8</option>
                                                    <option value="9">9</option>
                                                    <option value="10">10</option>
                                                    <option value="11">11</option>
                                                    <option value="12">12</option>
                                                </select>
                                            </li>
                                            <li class="pull-right">
                                                <a class="btn btn-primary btn-rounded btn-sm"
                                                   onclick="searchRetention()"><i class="fa fa-search"></i>&nbsp;搜索</a>
                                                <a class="btn btn-warning btn-rounded btn-sm" onclick="resetRetention()"><i
                                                        class="fa fa-refresh"></i>&nbsp;重置</a>
                                            </li>
                                        </ul>
                                    </div>
                                </form>
                            </div>
                            <div class="col-md-12" id="mask">
                                <div class="row">
                                    <div class="col-md-12">
                                        <div style="opacity:0.6;width: 100%;height: 300px;line-height:300px!important;background-color: #ddd;color: #383838;" class="text-center center-block">
                                            请选择过滤条件！
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="charts" hidden>
                                <div class="col-md-12">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div id="chart1" style="width: 100%;height: 300px;"></div>
                                        </div>
                                        <div class="col-md-6">
                                            <div id="chart2" style="width: 100%;height: 300px;"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-12">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div id="chart3" style="width: 100%;height: 300px;"></div>
                                        </div>
                                        <div class="col-md-6">
                                            <div id="chart4" style="width: 100%;height: 300px;"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-12">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div id="chart5" style="width: 100%;height: 300px;"></div>
                                        </div>
                                        <div class="col-md-6">
                                            <div id="chart6" style="width: 100%;height: 300px;"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>
<!-- 日历插件 -->
<script data-th-src="@{/plugins/echarts/echarts.min.js}"></script>
<script data-th-src="@{/plugins/echarts/macarons.js}"></script>
<script type="text/javascript" data-th-src="@{/plugins/bootstrap-year-calendar/js/bootstrap-year-calendar.js}"></script>
<script type="text/javascript"
        data-th-src="@{/plugins/bootstrap-year-calendar/js/languages/bootstrap-year-calendar.zh-CN.js}"></script>
<script data-th-src="@{/js/common/bootstrap-notify.min.js}"></script>
<script data-th-src="@{/js/common/lightyear.js}"></script>
<script data-th-src="@{/plugins/confirm/jquery-confirm.min.js}"></script>
<script data-th-src="@{/js/app/operate/insight/insight.js}"></script>
<script data-th-src="@{/plugins/ztree/jquery.ztree.core.js}"></script>
<script data-th-src="@{/plugins/ztree/jquery.ztree.excheck.js}"></script>
<script>
    var setting = {
        async: {
            enable: true,
            url: getUrl
        },
        check: {
            enable: true,
            chkStyle: "radio",
            radioType: "all"
        },
        view: {
            dblClickExpand: false,
            showIcon: false
        },
        data: {
            simpleData: {
                enable: true
            }
        },
        callback: {
            onClick: onClick,
            onCheck: onCheck,
            beforeExpand: beforeExpand,
            onAsyncSuccess: onAsyncSuccess,
            onAsyncError: onAsyncError
        }
    };

    function onClick(e, treeId, treeNode) {
        var zTree = $.fn.zTree.getZTreeObj("spuTree");
        zTree.checkNode(treeNode, !treeNode.checked, null, true);
        return false;
    }

    function onCheck(e, treeId, treeNode) {
        var zTree = $.fn.zTree.getZTreeObj("spuTree"),
            nodes = zTree.getCheckedNodes(true),
            v = "";
        for (var i=0, l=nodes.length; i<l; i++) {
            v += nodes[i].name + ",";
        }
        if (v.length > 0 ) v = v.substring(0, v.length-1);
        var spuOrProductName = $("#spuOrProductName");
        spuOrProductName.attr("value", v);
        $("#id").val(nodes[0].id);
        $("#menuContent").toggle();
        if(treeNode.isParent) {
            $("#type").val("spu");
        }else {
            $("#type").val("product");
        }
    }

    function beforeExpand(treeId, treeNode) {
        if (!treeNode.isAjaxing) {
            ajaxGetNodes(treeNode, "refresh");
            return true;
        } else {
            $MB.n_warning("正在下载数据中，请稍后展开节点...");
            return false;
        }
    }
    var className = "dark";
    function onAsyncSuccess(event, treeId, treeNode, msg) {
        if (!msg || msg.length == 0) {
            return;
        }
        var zTree = $.fn.zTree.getZTreeObj("spuTree"),
            totalCount = treeNode.count;
        if (treeNode.children.length < totalCount) {
            setTimeout(function() {ajaxGetNodes(treeNode);}, perTime);
        } else {
            treeNode.icon = "";
            zTree.updateNode(treeNode);
            zTree.selectNode(treeNode.children[0]);
            className = (className === "dark" ? "":"dark");
        }
    }
    function onAsyncError(event, treeId, treeNode, XMLHttpRequest, textStatus, errorThrown) {
        var zTree = $.fn.zTree.getZTreeObj("spuTree");
        $MB.n_danger("异步获取数据出现异常。");
        treeNode.icon = "";
        zTree.updateNode(treeNode);
    }
    function ajaxGetNodes(treeNode, reloadType) {
        var zTree = $.fn.zTree.getZTreeObj("spuTree");
        if (reloadType == "refresh") {
            zTree.updateNode(treeNode);
        }
        zTree.reAsyncChildNodes(treeNode, reloadType, true);
    }

    $(document).ready(function(){
        var left = $("#spuOrProductName").offset().left - $(".row").offset().left - 14;
        var width = $("#spuOrProductName").width() + 5;
        $("#spuTree").attr("style", "margin-left:"+ left +"px;width:"+width+"px;");

        const promise = new Promise(function (resolve, reject) {
            $.get("/insight/getSpuTree", {}, function (r){
                if(r.code === 200) {
                    resolve(r);
                } else {
                    reject(r);
                }
            });
        });
        initZtree();
        async function initZtree() {
            let result = await promise;
            $.fn.zTree.init($("#spuTree"), setting, result.data);
        }
    });

    $("#spuOrProductName").click(
        function () {
            $("#menuContent").toggle();
        }
    );
    
    function getUrl(treeId, treeNode) {
        return "/insight/getProductTree?spuWid=" + treeNode.id;
    }

    /**
     * 留存率随购买次数的变化图
     */
    function retentionInPurchaseTimes() {
        $.get("/insight/retentionInPurchaseTimes", {id: $("#id").val(), type: $("#type").val(), period: $("#period").val()}, function (r) {
            var option = getOption(r.data, "留存率");
            var chart = echarts.init(document.getElementById("chart1"), 'macarons');
            chart.setOption(option);
        });
    }

    /**
     * 件单价随购买次数变化
     */
    function unitPriceInPurchaseTimes() {
        $.get("/insight/unitPriceInPurchaseTimes", {id: $("#id").val(), type: $("#type").val(), period: $("#period").val()}, function (r) {
            var option = getOption(r.data, "件单价");
            var chart = echarts.init(document.getElementById("chart3"), 'macarons');
            chart.setOption(option);
        });
    }

    /**
     * 连带率随购买次数变化
     */
    function joinRateInPurchaseTimes() {
        $.get("/insight/joinRateInPurchaseTimes", {id: $("#id").val(), type: $("#type").val(), period: $("#period").val()}, function (r) {
            var option = getOption(r.data, "连带率");
            var chart = echarts.init(document.getElementById("chart4"), 'macarons');
            chart.setOption(option);
        });
    }

    /**
     * 品类种数随购买次数变化
     */
    function categoryInPurchaseTimes() {
        $.get("/insight/categoryInPurchaseTimes", {id: $("#id").val(), type: $("#type").val(), period: $("#period").val()}, function (r) {
            var option = getOption(r.data, "品类种数");
            var chart = echarts.init(document.getElementById("chart5"), 'macarons');
            chart.setOption(option);
        });
    }

    /**
     * 时间间隔随购买次数变化
     */
    function periodInPurchaseTimes() {
        $.get("/insight/periodInPurchaseTimes", {id: $("#id").val(), type: $("#type").val(), period: $("#period").val()}, function (r) {
            var option = getOption(r.data, "时间间隔");
            var chart = echarts.init(document.getElementById("chart6"), 'macarons');
            chart.setOption(option);
        });
    }

    function getOption(data, name) {
        return option = {
            xAxis: {
                name: '购买次数',
                type: 'category',
                data: data.xdata,
                splitLine:{show: false},
                splitArea : {show : false}
            },
            yAxis: {
                name: name,
                type: 'value',
                splitLine:{show: false},
                splitArea : {show : false}
            },
            series: [{
                data: data.ydata,
                type: 'line'
            }],
            grid: {right:'15%'},
            title: {
                text: name + '随购买次数变化',
                x: 'center',
                y: 'bottom',
                textStyle: {
                    //文字颜色
                    color: '#000',
                    //字体风格,'normal','italic','oblique'
                    fontStyle: 'normal',
                    //字体粗细 'normal','bold','bolder','lighter',100 | 200 | 300 | 400...
                    fontWeight: 'normal',
                    //字体系列
                    fontFamily: 'sans-serif',
                    //字体大小
                    fontSize: 12
                }
            }
        }
    }

    function searchRetention() {
        if($("#id").val() === '' || $("#period").val() === '') {
            $MB.n_warning("请选择商品/SPU，查询时间周期。");
            return false;
        }
        $("#mask").hide();
        $("#charts").show();
        retentionInPurchaseTimes();
        unitPriceInPurchaseTimes();
        joinRateInPurchaseTimes();
        categoryInPurchaseTimes();
        periodInPurchaseTimes();
    }

    // 重置留存率的条件
    function resetRetention() {
        $("#spuOrProductName").val("");
        $("#id").val("");
        $("#type").val("");
        $("#period").find("option:selected").removeAttr("selected");
    }
</script>
</body>
</html>

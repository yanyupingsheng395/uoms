<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="edge" />
    <title>用户成长系统</title>
    <link rel="shortcut icon" type="image/png" th:href="@{/images/favicon.ico}" />
    <link rel="stylesheet" data-th-href="@{/css/bootstrap.min.css}"/>
    <link rel="stylesheet" data-th-href="@{/css/materialdesignicons.min.css}"/>
    <link rel="stylesheet" data-th-href="@{/css/animate.css}"/>
    <link rel="stylesheet" data-th-href="@{/css/style.min.css}"/>
    <style>
        #pushTable thead {
            background-color: #eff3f8;
        }
    </style>
</head>

<body class="gray-bg">
<!-- 公共组件 -->
<div data-th-include="common/commonCSS"></div>
<div class="lyear-layout-web">
    <div class="lyear-layout-container">
        <!-- 页面主要内容 -->
        <main class="lyear-layout-content" style="padding-top: 0px; padding-left: 0px;">
            <div class="container-div ui-layout-center">
                <div class="row">
                    <div class="col-md-12 select-table table-striped">
                        <div class="row m-t-10">
                            <div class="col-md-12">
                                <p class="h4" id="status"></p>
                                <div class="btn-group-sm" role="group">
                                    <a class="btn btn-success btn-edit" onclick="start()">
                                        <i class="fa fa-play"></i> 启动推送
                                    </a>
                                    <a class="btn btn-danger btn-view" onclick="stop()">
                                        <i class="fa fa-stop"></i> 停止推送
                                    </a>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-default" onclick="getPushLog(1)"><i class="mdi mdi-plus"></i></button>
                                        <button class="btn btn-default" onclick="getPushLog(-1)"><i class="mdi mdi-minus"></i></button>
                                    </div>
                                </div>
                                <p class="h5 m-t-10">最后一次推送响应时间：<span id="lastPushDate"></span></p>
                                <p class="h5 m-t-10">最后一次批量推送响应时间：<span id="lastBatchPushDate"></span></p>
                                <p class="h5 m-t-10">最后一次清理拦截库时间：<span id="lastPurgeDate"></span></p>

                                <p class="h5 m-t-10">最后一次获取状态报告时间：<span id="lastRptDate"></span></p>
                                <p class="h5 m-t-10">最后一次获取上行消息时间：<span id="lastMoDate"></span></p>
                                <p class="h5 m-t-10" id="dateStr">日志日期：<span id="logDate"></span></p>
                            </div>
                        </div>

                        <div class="row m-t-10">
                            <div class="col-sm-12">

                                <table class="table  table-striped table-bordered text-nowrap">
                                    <caption>推送记录</caption>
                                    <thead>
                                    <tr>
                                        <th>推送时间</th>
                                        <th>备注</th>
                                        <th>人数</th>
                                    </tr>
                                    </thead>
                                    <tbody id="pushTableData"></tbody>
                                </table>
                                <table class="table  table-striped table-bordered text-nowrap">
                                    <caption>防重复拦截记录</caption>
                                    <thead>
                                    <tr>
                                        <th>防重复拦截时间</th>
                                        <th>备注</th>
                                        <th>人数</th>
                                    </tr>
                                    </thead>
                                    <tbody id="repeatTableData"></tbody>
                                </table>

                                <table class="table  table-striped table-bordered text-nowrap">
                                    <caption>拦截库失效运行记录</caption>
                                    <thead>
                                    <tr>
                                        <th>失效拦截库时间</th>
                                        <th>备注</th>
                                        <th>人数</th>
                                     </tr>
                                    </thead>
                                    <tbody id="purgeTableData"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>
<div data-th-include="common/commonJS"></div>
<script>
    window.onload = function () {
        status();
        getPushLog();
    };
    // 启动服务
    function start() {
        $.get("/push/start", {}, function (r) {
            if (r.code === 200) {
                $MB.n_success("已开启服务！");
                status();
            }
        });
    }

    // 停止服务
    function stop() {
        $.get("/push/stop", {}, function (r) {
            if (r.code === 200) {
                $MB.n_success("已停止服务！");
                status();
            }
        });
    }

    function status() {
        $.get("/push/status", {}, function (r) {
            let status = r.data;
            let code = "";
            if(status == 'Y') {
                code = "当前推送状态：<span style=\"color: #00B83F\">已启动</span>";
            }
            if(status == 'N') {
                code = "当前推送状态：<span style=\"color: #f96868\">已停止</span>";
            }
            if(status != 'Y' && status != "N") {
                code = "当前推送状态：<span>未知状态</span>";
            }
            $("#status").html('').append(code);
        });
    }

    let day = 0;
    // 获取推送日志
    function getPushLog(flag) {
        if (flag != undefined) {
            day = day + flag >0 ? 0 : day + flag;
        }
        $.get("/push/getPushLog", {day: Math.abs(day)}, function (r) {
            let data = r.data;
            let push = data.push;
            let repeat = data.repeat;
            let purge = data.purge;

            $("#logDate").text(data.logDate);
            $("#lastPushDate").text(data.lastPushDate);
            $("#lastBatchPushDate").text(data.lastBatchPushDate);
            $("#lastPurgeDate").text(data.lastPurgeDate);
            $("#lastRptDate").text(data.lastRptDate);
            $("#lastMoDate").text(data.lastMoDate);

            setTableData('pushTableData', push);
            setTableData('repeatTableData', repeat);
            setTableData('purgeTableData', purge);

        });
    }

    function setTableData(id, data) {
        let code = "";
        data.forEach(function(value, index, array) {
            code += "<tr><td>"+value['logDateStr']+"</td><td>"+value['logContent']+"</td><td>"+value['userCount']+"</td></tr>";
        });
        if(code == "") {
            code += "<tr class='text-center'><td colspan='3'>没有记录！</td></tr>";
        }
        $("#" + id).html('').append(code);
    }
</script>
</body>
</html>

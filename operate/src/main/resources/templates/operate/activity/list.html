<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="edge"/>
    <title>用户成长系统</title>
    <link rel="shortcut icon" type="image/png" th:href="@{/images/favicon.ico}"/>
    <link rel="stylesheet" data-th-href="@{/css/bootstrap.min.css}"/>
    <link rel="stylesheet" data-th-href="@{/css/materialdesignicons.min.css}"/>
    <link rel="stylesheet" data-th-href="@{/css/animate.css}"/>
    <link rel="stylesheet" data-th-href="@{/plugins/confirm/jquery-confirm.min.css}">
    <link rel="stylesheet" data-th-href="@{/css/style.min.css}"/>
    <link rel="stylesheet" type="text/css"
          data-th-href="@{/plugins/bootstrap-year-calendar/css/bootstrap-year-calendar.min.css}">
</head>

<body>
<!-- 公共组件 -->
<div data-th-include="common/common"></div>
<div class="lyear-layout-web">
    <div class="lyear-layout-container">
        <!-- 左侧导航 -->
        <div data-th-include="common/aside"></div>
        <!-- 头部信息 -->
        <div data-th-include="common/header"></div>
        <!-- 页面主要内容 -->
        <main class="lyear-layout-content">
            <div class="container-div ui-layout-center">
                <div class="row">
                    <div class="col-sm-12 search-collapse">
                        <div class="col-md-12">
                            <div class="row">
                                <h5 class="modal-title pull-left" style="margin-top: 20px;">活动驱动用户成长</h5>
                            </div>
                            <div class="row">
                                <hr class="hr"/>
                            </div>
                        </div>
                        <div class="row">
                            <hr style="background-color: rgba(77,82,89,0.05);"/>
                        </div>
                        <div class="col-md-12">
                            <div id="calendar" style="padding: 18px;"></div>
                        </div>
                        <div class="btn-group-sm text-center" role="group">
                            <a class="btn btn-primary" onclick="$('#activity-add').modal('show')">
                                <i class="fa fa-plus"></i> 新增活动
                            </a>
                        </div>
                    </div>
                    <div class="col-sm-12 search-collapse">
                        <div class="row" style="margin-top: 12px;">
                            <div class="col-md-12">
                                <form id="user-form">
                                    <div class="select-list">
                                        <ul>
                                            <li>
                                                活动名称：<input type="text" name="actName"/>
                                            </li>
                                            <li>
                                                <a class="btn btn-primary btn-rounded btn-sm"
                                                   onclick="searchActivity()"><i class="fa fa-search"></i>&nbsp;搜索</a>
                                                <a class="btn btn-warning btn-rounded btn-sm" onclick="resetActivity()"><i
                                                        class="fa fa-refresh"></i>&nbsp;重置</a>
                                            </li>
                                        </ul>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-12 select-table table-striped">
                        <div class="row" style="margin-top: 12px;">
                            <div class="col-sm-12">
                                <div class="btn-group-sm" id="toolbar" role="group">
                                    <a class="btn btn-success btn-edit" id="btn_add">
                                        <i class="fa fa-edit"></i> 编辑活动
                                    </a>
                                    <a class="btn btn-primary btn-edit" id="btn_view">
                                        <i class="fa fa-edit"></i> 查看活动
                                    </a>
                                    <button class="btn btn-info btn-view" id="btn_catch">
                                        <i class="fa fa-check-square-o"></i> 效果评估
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="row" style="margin-top: 12px;">
                            <div class="col-sm-12 table-striped">
                                <table id="activityTable" class="table table-striped table-bordered text-nowrap"></table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>
<div class="modal fade" id="activity-add" data-keyboard="false" data-backdrop="static" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">×</span></button>
                <h5 class="modal-title pull-left">新增活动</h5>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-12">
                        <form class="form-horizontal" method="post" id="activity-add-form">
                            <div class="form-group">
                                <label class="col-md-3 control-label">活动类型</label>
                                <div class="col-md-7">
                                    <select name="activityType" id="activityType" class="form-control">
                                        <option value="">请选择</option>
                                        <option value="own">自主</option>
                                        <option value="plat">平台</option>
                                    </select>
                                    <input type="hidden" id="activityTypeVal" name="activityTypeVal">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-md-3 control-label">活动名称</label>
                                <div class="col-md-7">
                                    <input class="form-control" id="activityName" name="activityName">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-md-3 control-label">开始日期</label>
                                <div class="col-md-7">
                                    <input class="form-control" id="startDate" name="startDate">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-md-3 control-label">结束日期</label>
                                <div class="col-md-7">
                                    <input class="form-control" id="endDate" name="endDate">
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary btn-save" id="activity-add-btn" name="save">保存</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
<!-- 日历插件 -->
<script type="text/javascript" data-th-src="@{/plugins/bootstrap-year-calendar/js/bootstrap-year-calendar.js}"></script>
<script type="text/javascript"
        data-th-src="@{/plugins/bootstrap-year-calendar/js/languages/bootstrap-year-calendar.zh-CN.js}"></script>
<script src="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script data-th-src="@{/js/common/bootstrap-notify.min.js}"></script>
<script data-th-src="@{/js/common/lightyear.js}"></script>
<script data-th-src="@{/plugins/confirm/jquery-confirm.min.js}"></script>
<script data-th-src="@{/js/app/operate/activity/list.js}"></script>
<script type="text/javascript">
    let validator;
    let $activityAddForm = $("#activity-add-form");

    function init() {
        init_date_begin('startDate', 'endDate', 'yyyy-mm-dd', 0, 2, 0);
        init_date_end('startDate', 'endDate', 'yyyy-mm-dd', 0, 2, 0);
        $('#startDate').datepicker('setStartDate', new Date());
    }

    $(function () {
        $MB.loading('show');
        init();
        validateRule();
        getCalendar();
        $MB.loading('hide');
    });


    function validateRule() {
        var icon = "<i class='zmdi zmdi-close-circle zmdi-hc-fw'></i> ";
        validator = $activityAddForm.validate({
            rules: {
                activityTypeVal: {
                    required: true
                },
                activityName: {
                    required: true
                },
                startDate: {
                    required: true
                },
                endDate: {
                    required: true
                }
            },
            errorPlacement: function (error, element) {
                if (element.is(":checkbox") || element.is(":radio")) {
                    error.appendTo(element.parent().parent());
                } else {
                    error.insertAfter(element);
                }
            },
            messages: {
                activityTypeVal: {
                    required: icon + "请输入活动类型"
                },
                activityName: {
                    required: icon + "请输入活动名称"
                },
                startDate: {
                    required: icon + "请输入开始日期"
                },
                endDate: {
                    required: icon + "请输入结束日期"
                }
            }
        });
    }

    $("#activityType").change(function () {
        $("#activityTypeVal").val($(this).find("option:selected").val());
    });

    $("#activity-add-btn").click(function () {
        let validator = $activityAddForm.validate();
        let flag = validator.form();
        if (flag) {
            $.post("/activity/saveActivityConfig", $activityAddForm.serialize(), function (r) {
                $("#activity-add").modal('hide');
                if (r.code == 200) {
                    $MB.n_success("新增活动成功！");
                    getCalendar();
                } else {
                    $MB.n_danger("未知错误！");
                }
                getCalendarDataSource();
            });
        }
    });

    // 关闭modal清空值
    $("#activity-add").on('hidden.bs.modal', function () {
        $("#activityType").find("option[value='']").prop("selected", "selected");
        $("#activityName").val("");
        $("#startDate").val("");
        $("#endDate").val("");
    });

    // 封装calendar的datasource
    function getCalendarDataSource() {
        let data = getActivityConfig();
        let dataSource = [];
        data.forEach(e => {
            let o = new Object();
            o.id = e.id;
            o.name = e.activityName;
            o.startDate = detailDate(e.startDate);
            o.endDate = detailDate(e.endDate);
            dataSource.push(o);
        });

        return dataSource;
    }

    // 将日期处理成calendar需要的日期
    function detailDate(date) {
        let dateArr = date.split("-");
        return new Date(Number.parseInt(dateArr[0]), Number.parseInt(dateArr[1]) - 1, Number.parseInt(dateArr[2]));
    }

    // 获取日历
    function getCalendar() {
        $('#calendar').html('');
        let date = new Date();
        let today = new Date(date.getFullYear(), date.getMonth(), date.getDate()).getTime();
        let dataSource = getCalendarDataSource();
        $('#calendar').calendar({
            language: 'zh-CN',
            mouseOnDay: function (e) {
                let content = '';
                for (let i in e.events) {
                    content += '<div class="event-tooltip-content">'
                        + '<div class="event-name">' + e.events[i].name + '</div>'
                        + '</div>';
                }
                $(e.element).popover({
                    trigger: 'manual',
                    container: 'body',
                    html: true,
                    content: content,
                    placement: 'top'
                });

                $(e.element).popover('show');
            },
            mouseOutDay: function (e) {
                if (e.events.length > 0) {
                    $(e.element).popover('hide');
                }
            },
            dataSource: dataSource,
            customDayRenderer: function (element, date) {
                if (date.getTime() == today) {
                    $(element).css('background-color', 'red');
                    $(element).css('color', 'white');
                    $(element).css('border-radius', '2px');
                }
            }
        });
        $('[data-toggle="tooltip"]').tooltip({
            "container": 'body',
        });
    }

    // 获取创建的活动
    function getActivityConfig() {
        let data = null;
        $.ajax({
            url: '/activity/getActivityConfig',
            data: {},
            async: false,
            success: function (r) {
                data = r.data;
            }
        });
        return data;
    }

    $("#btn_view").click(function () {
        var headId = $("#activityTable").bootstrapTable('getSelections')[0].headId;
        if (null == headId || ""== headId) {
            $MB.n_warning('请勾选需要评估的活动！');
            return;
        }
        window.location.href = "/page/activity/view?id=" + headId;
    });
</script>
</body>
</html>

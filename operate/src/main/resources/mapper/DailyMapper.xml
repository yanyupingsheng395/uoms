<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.linksteady.operate.dao.DailyMapper">

    <resultMap id="baseResult" type="com.linksteady.operate.domain.DailyHead">
        <result column="HEAD_ID" property="headId" jdbcType="DECIMAL"></result>
        <result column="TOTAL_NUM" property="totalNum" jdbcType="DECIMAL"></result>
        <result column="SUCCESS_NUM" property="successNum" jdbcType="DECIMAL"></result>
        <result column="CONVERT_RATE" property="convertRate" jdbcType="DECIMAL"></result>
        <result column="CONVERT_AMOUNT" property="convertAmount" jdbcType="DECIMAL"></result>
        <result column="TOUCH_DT" property="touchDt" jdbcType="DATE"></result>
        <result column="TOUCH_DT_STR" property="touchDtStr" jdbcType="VARCHAR"></result>
        <result column="CONVERT_NUM" property="convertNum" jdbcType="DECIMAL"></result>
        <result column="CONVERT_AMOUNT" property="convertAmount" jdbcType="DECIMAL"></result>
        <result column="CONVERT_RATE" property="convertRate" jdbcType="DECIMAL"></result>
        <result column="CONVERT_SPU_AMOUNT" property="convertSpuAmount" jdbcType="DECIMAL"></result>
        <result column="CONVERT_SPU_NUM" property="convertSpuNum" jdbcType="DECIMAL"></result>
        <result column="CONVERT_SPU_RATE" property="convertSpuRate" jdbcType="DECIMAL"></result>
        <result column="STATUS" property="status" jdbcType="VARCHAR"></result>
        <result column="OP_CHANGED_TIME" property="opChangeDate" jdbcType="DECIMAL"></result>
    </resultMap>

    <resultMap id="templateResult" type="com.linksteady.operate.domain.DailyGroupTemplate">
        <result column="GROUP_ID" jdbcType="VARCHAR" property="groupId"></result>
        <result column="GROUP_NAME" jdbcType="VARCHAR" property="groupName"></result>
        <result column="SMS_CODE" jdbcType="VARCHAR" property="smsCode"></result>
        <result column="SMS_CONTENT" jdbcType="VARCHAR" property="smsContent"></result>
        <result column="IS_COUPON" jdbcType="VARCHAR" property="isCoupon"></result>
        <result column="COUPON_NAME" jdbcType="VARCHAR" property="couponName"></result>
        <result column="USER_VALUE" jdbcType="VARCHAR" property="userValue"></result>
        <result column="PATH_ACTIVE" jdbcType="VARCHAR" property="pathActive"></result>
        <result column="LIFECYCLE" jdbcType="VARCHAR" property="lifecycle"></result>
        <result column="CHECK_FLAG" jdbcType="VARCHAR" property="checkFlag"></result>
        <result column="CHECK_COMMENTS" jdbcType="VARCHAR" property="checkComments"></result>
        <result column="GROUP_INFO" jdbcType="VARCHAR" property="groupInfo"></result>
    </resultMap>

    <resultMap id="statisResult" type="com.linksteady.operate.domain.DailyStatis">
        <result column="HEAD_ID" jdbcType="DECIMAL" property="headId"></result>
        <result column="CONVERT_SPU_RATE" jdbcType="DECIMAL" property="convertSpuRate"></result>
        <result column="CONVERT_RATE" jdbcType="DECIMAL" property="convertRate"></result>
        <result column="CONVERT_SPU_NUM" jdbcType="DECIMAL" property="convertSpuNum"></result>
        <result column="CONVERT_NUM" jdbcType="DECIMAL" property="convertNum"></result>
        <result column="TOUCH_DATE" jdbcType="DECIMAL" property="touchDate"></result>
        <result column="CONVERSION_DATE" jdbcType="DATE" property="conversionDate"></result>
        <result column="CONVERSION_DATE_STR" jdbcType="VARCHAR" property="conversionDateStr"></result>
    </resultMap>

    <!--每日运营个体效果-->
    <resultMap id="personalResult" type="com.linksteady.operate.domain.DailyPersonal">
        <result property="userId" jdbcType="VARCHAR" column="USER_ID"></result>
        <result property="isConvert" jdbcType="VARCHAR" column="IS_CONVERT"></result>
        <result property="pushPeriod" jdbcType="VARCHAR" column="PUSH_PERIOD"></result>
        <result property="convertPeriod" jdbcType="VARCHAR" column="CONVERT_PERIOD"></result>
        <result property="convertInterval" jdbcType="VARCHAR" column="CONVERT_INTERVAL"></result>
        <result property="pushSpu" jdbcType="VARCHAR" column="PUSH_SPU"></result>
        <result property="convertSpu" jdbcType="VARCHAR" column="CONVERT_SPU"></result>
        <result property="spuIsConvert" jdbcType="VARCHAR" column="SPU_IS_CONVERT"></result>
        <result property="userValue" jdbcType="VARCHAR" column="USER_VALUE"></result>
        <result property="pathActive" jdbcType="VARCHAR" column="PATH_ACTIVE"></result>
        <result property="userName" jdbcType="VARCHAR" column="USER_NAME"></result>
        <result property="mobile" jdbcType="VARCHAR" column="MOBILE"></result>
        <result property="pushDate" jdbcType="VARCHAR" column="PUSH_DATE"></result>
        <result property="convertDate" jdbcType="VARCHAR" column="CONVERT_DATE"></result>
    </resultMap>

    <resultMap id="DailyUserStatsResult" type="com.linksteady.operate.domain.DailyUserStats">
        <result property="userValue" jdbcType="VARCHAR" column="USER_VALUE"></result>
        <result property="pathActivity" jdbcType="VARCHAR" column="PATH_ACTIVE"></result>
        <result property="lifecycle" jdbcType="VARCHAR" column="LIFECYCLE"></result>
        <result property="ucnt" jdbcType="DECIMAL" column="UCNT"></result>
        <result property="pct" jdbcType="DECIMAL" column="PCT"></result>
        <result property="spuName" jdbcType="VARCHAR" column="SPU_NAME"></result>
        <result property="prodName" jdbcType="VARCHAR" column="REC_PROD_NAME"></result>
    </resultMap>

    <select id="getPageList" resultMap="baseResult">
        select * from (
        select t.*, ROWNUM rn from (
        SELECT HEAD_ID, to_char(TOUCH_DT, 'yyyymmdd') TOUCH_DT_STR, TOTAL_NUM, SUCCESS_NUM,CONVERT_NUM, CONVERT_RATE, CONVERT_AMOUNT, STATUS
        FROM UO_OP_DAILY_HEADER t
        <where>
            <if test="touchDt != null and touchDt != ''">
                to_char(touch_dt, 'yyyy-mm-dd') = #{touchDt}
            </if>
        </where>
        ORDER BY HEAD_ID desc
        ) t where ROWNUM &lt;= #{end}
        )where rn &gt;= #{start}
    </select>

    <select id="getTotalCount" resultType="int">
        select count(1) from UO_OP_DAILY_HEADER
        where 1=1
        <if test="touchDt != '' and touchDt != null">
            and to_char(touch_dt, 'YYYY-MM-DD') = #{touchDt}
        </if>
    </select>

    <select id="getTouchPageList" resultMap="baseResult">
        select * from (
        select t.*, ROWNUM rn from (
        SELECT HEAD_ID, TOUCH_DT, ACTUAL_NUM, PLAN_NUM, FAILD_NUM, SUCCESS_NUM, STATUS
        FROM UO_OP_DAILY_HEADER
        where 1=1 and STATUS in ('doing', 'done', 'finished')
        <if test="touchDt != ''">
            and to_char(TOUCH_DT, 'YYYY-MM-DD') = #{touchDt}
        </if>
        ORDER BY TOUCH_DT desc
        ) t where ROWNUM &lt;= #{end}
        )where rn &gt;= #{start}
    </select>

    <select id="getTouchTotalCount" resultType="int">
        select count(1) from UO_OP_DAILY_HEADER
        where 1=1 and STATUS in ('doing', 'done', 'finished')
        <if test="touchDt != ''">
            and to_char(touch_dt, 'YYYY-MM-DD') = #{touchDt}
        </if>
    </select>

    <update id="updateStatus">
        update UO_OP_DAILY_HEADER set status = #{status} where head_id = #{headId}
    </update>

    <update id="updateActualNum">
        update UO_OP_DAILY_HEADER set OPT_NUM = #{num} where head_id = #{headId}
    </update>

    <select id="getDailyHeadById" resultMap="baseResult">
        SELECT HEAD_ID, TOUCH_DT,to_char(TOUCH_DT, 'yyyymmdd') TOUCH_DT_STR, TOTAL_NUM, SUCCESS_NUM,CONVERT_NUM, CONVERT_RATE, CONVERT_AMOUNT, STATUS,op_changed_time
         FROM UO_OP_DAILY_HEADER WHERE HEAD_ID = #{headId}
    </select>

    <select id="getTouchDt" resultType="string">
        select to_char(TOUCH_DT, 'yyyymmdd') from UO_OP_DAILY_HEADER where head_id = #{headId}
    </select>

    <select id="getTaskInfo" resultType="map">
        select to_char(TOUCH_DT, 'yyyymmdd') TOUCH_DT, SUCCESS_NUM from UO_OP_DAILY_HEADER where head_id = #{headId}
    </select>

    <select id="getTotalNum" resultType="map">
        select total_num total, OPT_NUM opt from UO_OP_DAILY_HEADER where head_id = #{headId}
    </select>

    <select id="getUserGroupList" resultMap="templateResult">
        select * from (
        SELECT t1.GROUP_ID, GROUP_NAME, t1.IS_COUPON, t1.SMS_CODE, t2.SMS_CONTENT,t1.USER_VALUE,
               t1.PATH_ACTIVE, t1.LIFECYLE LIFECYCLE,
               LISTAGG(t4.COUPON_DISPLAY_NAME, ',') within group (order by t4.coupon_id) coupon_name, t1.CHECK_FLAG, t1.CHECK_COMMENTS,
               t1.GROUP_INFO
        FROM UO_OP_DAILY_TEMPLATE_CONFIG t1, UO_OP_SMS_TEMPLATE t2,
             UO_OP_DAILY_GROUP_COUPON t3, UO_OP_COUPON t4
        where t1.SMS_CODE = t2.SMS_CODE(+)
          and t1.group_id = t3.group_id(+)
          and t3.coupon_id = t4.coupon_id(+)
        group by t1.GROUP_ID, GROUP_NAME, t1.IS_COUPON, t1.SMS_CODE, t2.SMS_CONTENT,t1.USER_VALUE, t1.CHECK_FLAG, t1.PATH_ACTIVE, t1.LIFECYLE, t1.CHECK_COMMENTS, t1.GROUP_INFO
        ORDER BY USER_VALUE asc, LIFECYLE desc, t1.PATH_ACTIVE asc
        )
        <if test="activeList != null">
            where PATH_ACTIVE in
            <foreach collection="activeList" separator="," item="item" open="(" close=")">
                #{item}
            </foreach>
        </if>
    </select>

    <update id="setSmsCode">
        update UO_OP_DAILY_TEMPLATE_CONFIG
        set SMS_CODE = #{smsCode}, is_coupon = (
        select count(1) from UO_OP_SMS_TEMPLATE
        where (IS_COUPON_NAME = '1' or IS_COUPON_URL = '1') and SMS_CODE = #{smsCode}
        )
        where 1=1 and group_id in
        <foreach collection="groupIds" open="(" close=")" separator="," item="item">
            ${item}
        </foreach>
    </update>

    <update id="updateHeaderToFinish">
        UPDATE UO_OP_DAILY_HEADER c SET c.STATUS='finished' WHERE c.STATUS='done' AND not exists
                                                                (
            select * from UO_OP_DAILY_DETAIL p where p.PUSH_STATUS='P' and p.head_id=c.head_id
            )
    </update>

    <update id="updateHeaderSendStatis">
        update UO_OP_DAILY_HEADER t
        set (t.plan_num,t.faild_num,t.success_num)=
            (
             select
             SUM(case when c.PUSH_STATUS='P' then 1 else 0 end) plan_num,
             SUM(case when c.PUSH_STATUS='F' then 1 else 0 end) faild_num,
             SUM(case when c.PUSH_STATUS='S' then 1 else 0 end) success_num
             from UO_OP_DAILY_DETAIL c where c.head_id = t.head_id
            )where
            trunc(touch_dt)>trunc(sysdate-15) and status in ('done','finished')
    </update>

    <select id="validUserGroup" resultType="int">
        select count(1)
        from (
               SELECT t1.GROUP_ID,
                      t1.IS_COUPON,
                      t1.SMS_CODE,
                      t2.SMS_CONTENT,
                      LISTAGG(t4.coupon_name, ',') within group (order by t4.coupon_id) coupon_name
               FROM UO_OP_DAILY_TEMPLATE_CONFIG t1,
                    UO_OP_SMS_TEMPLATE t2,
                    UO_OP_DAILY_GROUP_COUPON t3,
                    UO_OP_COUPON t4
               where t1.SMS_CODE = t2.SMS_CODE(+)
                 and t1.group_id = t3.group_id(+)
                 and t3.coupon_id = t4.coupon_id(+)
               group by t1.GROUP_ID, t1.IS_COUPON, t1.SMS_CODE, t2.SMS_CONTENT
             )
        where (IS_COUPON = 1 and coupon_name is null)
           or (IS_COUPON = 0 and coupon_name is not null)
           or SMS_CONTENT is null
    </select>

    <select id="getEffectById" resultMap="baseResult">
        select TOTAL_NUM, SUCCESS_NUM,CONVERT_NUM, CONVERT_RATE, CONVERT_AMOUNT, CONVERT_SPU_NUM, CONVERT_SPU_RATE, CONVERT_SPU_AMOUNT
        from UO_OP_DAILY_HEADER
        where HEAD_ID = #{id} and status &lt;&gt; 'todo'
    </select>

    <select id="getDailyStatisList" resultMap="statisResult">
        select CONVERT_SPU_RATE, CONVERT_RATE, CONVERT_SPU_NUM, CONVERT_NUM, to_char(CONVERSION_DATE, 'yyyymmdd') CONVERSION_DATE_STR
        from UO_OP_DAILY_STATIS
        where HEAD_ID = #{headId} order by CONVERSION_DATE asc
    </select>

    <select id="getDailyPersonalEffect" resultMap="personalResult" parameterType="com.linksteady.operate.vo.DailyPersonalVo">
        select * from (
          select tt.*, ROWNUM RN from (
        select
        t.user_id, --用户ID
        u.login_name user_name,  --用户名
        u.mobile, --手机号
        t.path_active, --活跃度
        t.user_value,  --用户价值
        t.push_period,  --推送时段
        t.conversion_period CONVERT_PERIOD,  --转化时段
        t.push_date,  --推送日期
        t.conversion_date convert_date, --转化日期
        trunc((t.conversion_date-t.push_date),1) CONVERT_INTERVAL, --转换间隔
        t.spu_consistent, --推荐SPU与购买SPU是否一致 Y表示是 N表示否
        t.rec_spu_name PUSH_SPU,  --推荐SPU名称
        t.IS_CONVERSION IS_CONVERT,
        t.SPU_CONSISTENT SPU_IS_CONVERT
        --转化的SPU名称
        from UO_OP_DAILY_CONVERT_DETAIL t, w_users u
        where t.user_id = u.id and IS_CONVERSION = '1'
        and t.daily_header_id=#{headId}
        <if test="dailyPersonalVo.spuIsConvert != null and dailyPersonalVo.spuIsConvert != ''">
            and SPU_CONSISTENT = #{dailyPersonalVo.spuIsConvert}
        </if>
        <if test="dailyPersonalVo.userValue != null and dailyPersonalVo.userValue != ''">
            and USER_VALUE = #{dailyPersonalVo.userValue}
        </if>
        <if test="dailyPersonalVo.pathActive != null and dailyPersonalVo.pathActive != ''">
            and PATH_ACTIVE = #{dailyPersonalVo.pathActive}
        </if>
          ) tt where ROWNUM &lt;= #{end}
        ) where RN &gt;= #{start}
    </select>

    <select id="getDailyPersonalEffectCount" resultType="int" parameterType="com.linksteady.operate.vo.DailyPersonalVo">
        select count(1) from UO_OP_DAILY_CONVERT_DETAIL where DAILY_HEADER_ID = #{headId} and IS_CONVERSION = '1'
        <if test="dailyPersonalVo.spuIsConvert != null and dailyPersonalVo.spuIsConvert != ''">
            and SPU_CONSISTENT = #{dailyPersonalVo.spuIsConvert}
        </if>
        <if test="dailyPersonalVo.userValue != null and dailyPersonalVo.userValue != ''">
            and USER_VALUE = #{dailyPersonalVo.userValue}
        </if>
        <if test="dailyPersonalVo.pathActive != null and dailyPersonalVo.pathActive != ''">
            and PATH_ACTIVE = #{dailyPersonalVo.pathActive}
        </if>
    </select>

    <update id="updateGroupCheckFlagByCouponId">
        update UO_OP_DAILY_TEMPLATE_CONFIG set CHECK_FLAG = #{checkFlag}, CHECK_COMMENTS = '券已失效'
        where GROUP_ID in (
            select distinct GROUP_ID from UO_OP_DAILY_GROUP_COUPON where COUPON_ID = #{couponId}
        )
    </update>

    <update id="updateCheckFlagAndRemark">
        update UO_OP_DAILY_TEMPLATE_CONFIG set CHECK_FLAG = 'N', CHECK_COMMENTS = #{remark}
        where GROUP_ID in (
            SELECT t1.GROUP_ID
            FROM UO_OP_DAILY_TEMPLATE_CONFIG t1,
                  UO_OP_SMS_TEMPLATE t2,
                  UO_OP_DAILY_GROUP_COUPON t3,
                  UO_OP_COUPON t4
             where t1.SMS_CODE = t2.SMS_CODE(+)
               and t1.group_id = t3.group_id(+)
               and t3.coupon_id = t4.coupon_id(+)
               ${whereInfo}
        )
    </update>

    <update id="updateCheckFlagY">
        update UO_OP_DAILY_TEMPLATE_CONFIG set CHECK_FLAG = 'Y', CHECK_COMMENTS = ''
    </update>

    <update id="updateHeaderOpChangeDate">
        update UO_OP_DAILY_HEADER set op_changed_time = #{opChangeDate} where head_id = #{headId}
    </update>

    <select id="validateOpChangeTime" resultType="int">
       select count(*) from UO_OP_DAILY_HEADER where head_id = #{headId} and op_changed_time = #{opChangeDate}
    </select>

    <select id="getUserStats" resultMap="DailyUserStatsResult">
        SELECT USER_VALUE,
               PATH_ACTIVE,
               LIFECYCLE,
               UCNT,
               ROUND(UCNT / SUM(UCNT) OVER(PARTITION BY NULL), 4) * 100 PCT
        FROM (SELECT T.USER_VALUE,
                     T.PATH_ACTIVE,
                     (CASE WHEN T.COMPLETE_PURCH = 1 THEN '1' ELSE '0' END) LIFECYCLE,
                     COUNT(*) UCNT
              FROM UO_OP_DAILY_DETAIL T
              WHERE T.HEAD_ID = #{headId}
              GROUP BY T.USER_VALUE,
                       T.PATH_ACTIVE,
                  (CASE WHEN T.COMPLETE_PURCH = 1 THEN '1' ELSE '0' END)
        ORDER BY UCNT DESC)
    </select>

    <select id="getUserStatsBySpu" resultMap="DailyUserStatsResult">
        SELECT
               SPU_NAME,
                UCNT
        FROM (SELECT T.SPU_NAME,
        COUNT(*) UCNT
        FROM UO_OP_DAILY_DETAIL T
        WHERE T.HEAD_ID = #{headId}
        AND T.PATH_ACTIVE= #{pathActive}
        AND T.USER_VALUE= #{userValue}
        AND (CASE WHEN T.COMPLETE_PURCH = 1 THEN '1' ELSE '0' END)= #{lifecycle}
        GROUP BY T.SPU_NAME
        ORDER BY UCNT DESC) WHERE ROWNUM &lt;=10
    </select>

    <select id="getUserStatsByProd" resultMap="DailyUserStatsResult">
        SELECT      REC_PROD_NAME,
        UCNT
        FROM (SELECT T.REC_PROD_NAME,
        COUNT(*) UCNT
        FROM UO_OP_DAILY_DETAIL T
        WHERE T.HEAD_ID = #{headId}
        AND T.PATH_ACTIVE=#{pathActive}
        AND T.USER_VALUE= #{userValue}
        AND (CASE WHEN T.COMPLETE_PURCH = 1 THEN '1' ELSE '0' END)= #{lifecycle}
        AND T.SPU_NAME= #{spuName}
        GROUP BY T.REC_PROD_NAME
        ORDER BY UCNT DESC) WHERE ROWNUM &lt;=10
    </select>

    <select id="validCheckedUserGroup" resultType="int">
        select count(1) from UO_OP_DAILY_TEMPLATE_CONFIG where CHECK_FLAG = 'N' and PATH_ACTIVE in
        <foreach collection="activeList" open="(" close=")" item="item" separator=",">
            #{item}
        </foreach>
    </select>

    <select id="getTodayStatus" resultType="string">
        select STATUS from UO_OP_DAILY_HEADER where to_char(TOUCH_DT, 'yyyymmdd') = to_char(sysdate, 'yyyymmdd')
    </select>
</mapper>
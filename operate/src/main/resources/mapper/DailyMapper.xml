<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.linksteady.operate.dao.DailyMapper">

    <resultMap id="baseResult" type="com.linksteady.operate.domain.DailyInfo">
        <result column="HEAD_ID" property="headId" jdbcType="DECIMAL"></result>
        <result column="TOTAL_NUM" property="totalNum" jdbcType="DECIMAL"></result>
        <result column="ACTUAL_NUM" property="actualNum" jdbcType="DECIMAL"></result>
        <result column="PLAN_NUM" property="planNum" jdbcType="DECIMAL"></result>
        <result column="FAILD_NUM" property="faildNum" jdbcType="DECIMAL"></result>
        <result column="SUCCESS_NUM" property="successNum" jdbcType="DECIMAL"></result>
        <result column="TOUCH_RATE" property="touchRate" jdbcType="DECIMAL"></result>
        <result column="CONVERT_COUNT" property="convertCount" jdbcType="DECIMAL"></result>
        <result column="CONVERT_RATE" property="convertRate" jdbcType="DECIMAL"></result>
        <result column="CONVERT_AMOUNT" property="convertAmount" jdbcType="DECIMAL"></result>
        <result column="TOUCH_DT" property="touchDt" jdbcType="DATE"></result>
        <result column="STATUS" property="status" jdbcType="VARCHAR"></result>
        <result column="TOUCH_COUNT" property="touchCount" jdbcType="DECIMAL"></result>
        <result column="EXECUTE_RATE" property="executeRate" jdbcType="DECIMAL"></result>
    </resultMap>

    <resultMap id="templateResult" type="com.linksteady.operate.domain.DailyGroupTemplate">
        <result column="GROUP_ID" jdbcType="VARCHAR" property="groupId"></result>
        <result column="GROUP_NAME" jdbcType="VARCHAR" property="groupName"></result>
        <result column="SMS_CODE" jdbcType="VARCHAR" property="smsCode"></result>
        <result column="SMS_CONTENT" jdbcType="VARCHAR" property="smsContent"></result>
        <result column="IS_COUPON" jdbcType="VARCHAR" property="isCoupon"></result>
        <result column="COUPON_NAME" jdbcType="VARCHAR" property="couponName"></result>
        <result column="USER_VALUE" jdbcType="VARCHAR" property="userValue"></result>
        <result column="PATH_ACTIVE" jdbcType="VARCHAR" property="pathActive"></result>
        <result column="LIFECYCLE" jdbcType="VARCHAR" property="lifecycle"></result>
    </resultMap>

    <select id="getPageList" resultMap="baseResult">
        select * from (
        select t.*, ROWNUM rn from (
        SELECT T1.HEAD_ID, T1.TOUCH_DT, T1.TOTAL_NUM, T2.EXECUTE_RATE, T2.TOUCH_COUNT, T2.TOUCH_RATE,
        T2.CONVERT_COUNT,T2.CONVERT_RATE, T2.CONVERT_AMOUNT, T1.STATUS
        FROM UO_OP_DAILY_HEADER T1, UO_OP_DAILY_STATIS T2 where T1.HEAD_ID = T2.HEAD_ID(+)
        <if test="touchDt != '' and touchDt != null">
            and to_char(t1.touch_dt, 'yyyy-mm-dd') = #{touchDt}
        </if>
        ORDER BY T1.HEAD_ID desc
        ) t where ROWNUM &lt;= #{end}
        )where rn &gt;= #{start}
    </select>

    <select id="getTotalCount" resultType="int">
        select count(1) from UO_OP_DAILY_HEADER
        where 1=1
        <if test="touchDt != '' and touchDt != null">
            and to_char(touch_dt, 'YYYY-MM-DD') = #{touchDt}
        </if>
    </select>

    <select id="getTouchPageList" resultMap="baseResult">
        select * from (
        select t.*, ROWNUM rn from (
        SELECT HEAD_ID, TOUCH_DT, ACTUAL_NUM, PLAN_NUM, FAILD_NUM, SUCCESS_NUM, STATUS
        FROM UO_OP_DAILY_HEADER
        where 1=1 and STATUS in ('doing', 'done', 'finished')
        <if test="touchDt != ''">
            and to_char(TOUCH_DT, 'YYYY-MM-DD') = #{touchDt}
        </if>
        ORDER BY TOUCH_DT desc
        ) t where ROWNUM &lt;= #{end}
        )where rn &gt;= #{start}
    </select>

    <select id="getTouchTotalCount" resultType="int">
        select count(1) from UO_OP_DAILY_HEADER
        where 1=1 and STATUS in ('doing', 'done', 'finished')
        <if test="touchDt != ''">
            and to_char(touch_dt, 'YYYY-MM-DD') = #{touchDt}
        </if>
    </select>

    <select id="getTipInfo" resultType="map">
        select to_char(touch_dt, 'YYYY-MM-DD') touchDt, TOTAL_NUM total from UO_OP_DAILY_HEADER where head_id = #{headId}
    </select>

    <update id="updateStatus">
        update UO_OP_DAILY_HEADER set status = #{status} where head_id = #{headId}
    </update>

    <update id="updateActualNum">
        update UO_OP_DAILY_HEADER set OPT_NUM = #{num} where head_id = #{headId}
    </update>

    <select id="getStatusById" resultType="string">
        SELECT STATUS FROM UO_OP_DAILY_HEADER WHERE HEAD_ID = #{headId}
    </select>

    <select id="getKpiVal" resultMap="baseResult">
        select TOTAL_NUM, SUCCESS_NUM, CONVERT_COUNT,EXECUTE_RATE, TOUCH_RATE, CONVERT_RATE
        from UO_OP_DAILY_HEADER t1, UO_OP_DAILY_STATIS t2 where t1.head_id = #{headId} and t1.head_id = t2.head_id(+)
    </select>

    <select id="getTouchDt" resultType="string">
        select to_char(TOUCH_DT, 'yyyymmdd') from UO_OP_DAILY_HEADER where head_id = #{headId}
    </select>

    <select id="getTotalNum" resultType="map">
        select total_num total, OPT_NUM opt from UO_OP_DAILY_HEADER where head_id = #{headId}
    </select>

    <select id="findById" resultMap="baseResult">
        select head_id, total_num, descr, insert_dt, update_dt, touch_dt, status, plan_num, faild_num, success_num from UO_OP_DAILY_HEADER where HEAD_ID = #{headId}
    </select>

    <select id="getUserGroupCount" resultType="int">
        select count(1) from UO_OP_DAILY_TEMPLATE_CONFIG
    </select>

    <select id="getUserGroupListPage" resultMap="templateResult">
        select * from (
        select t.*, ROWNUM rn from (
        SELECT t1.GROUP_ID, GROUP_NAME, t1.IS_COUPON, t1.SMS_CODE, t2.SMS_CONTENT,t1.USER_VALUE,
               t1.PATH_ACTIVE, t1.LIFECYLE LIFECYCLE,
               LISTAGG(t4.coupon_name, ',') within group (order by t4.coupon_id) coupon_name
        FROM UO_OP_DAILY_TEMPLATE_CONFIG t1, UO_OP_SMS_TEMPLATE t2,
             UO_OP_DAILY_GROUP_COUPON t3, UO_OP_COUPON t4
        where t1.SMS_CODE = t2.SMS_CODE(+)
          and t1.group_id = t3.group_id(+)
          and t3.coupon_id = t4.coupon_id(+)
        group by t1.GROUP_ID, GROUP_NAME, t1.IS_COUPON, t1.SMS_CODE, t2.SMS_CONTENT,t1.USER_VALUE,
                 t1.PATH_ACTIVE, t1.LIFECYLE
        ORDER BY USER_VALUE asc, LIFECYLE desc
        ) t where ROWNUM &lt;= #{end}
        )where rn &gt;= #{start}
    </select>

    <update id="setSmsCode">
        update UO_OP_DAILY_TEMPLATE_CONFIG
        <set>
            SMS_CODE = #{smsCode}
        </set>
        where 1=1 and group_id in
        <foreach collection="groupIds" open="(" close=")" separator="," item="item">
            ${item}
        </foreach>
    </update>

    <update id="updateHeaderToFinish">
        UPDATE UO_OP_DAILY_HEADER c SET c.STATUS='finished' WHERE c.STATUS='done' AND not exists
                                                                (
            select * from UO_OP_DAILY_DETAIL p where p.PUSH_STATUS='P' and p.head_id=c.head_id
            )
    </update>

    <update id="updateHeaderSendStatis">
        update UO_OP_DAILY_HEADER t
        set (t.plan_num,t.faild_num,t.success_num)=
            (
             select
             SUM(case when c.PUSH_STATUS='P' then 1 else 0 end) plan_num,
             SUM(case when c.PUSH_STATUS='F' then 1 else 0 end) faild_num,
             SUM(case when c.PUSH_STATUS='S' then 1 else 0 end) success_num
             from UO_OP_DAILY_DETAIL c where c.head_id = t.head_id
            )where
            trunc(touch_dt)>trunc(sysdate-15) and status in ('done','finished')
    </update>
</mapper>
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.linksteady.operate.dao.DailyDetailMapper">

    <resultMap id="baseResult" type="com.linksteady.operate.domain.DailyDetail">
        <result column="DAILY_DETAIL_ID" jdbcType="DECIMAL" property="dailyDetailId"></result>
        <result column="HEAD_ID" jdbcType="DECIMAL" property="headId"></result>
        <result column="USER_ID" jdbcType="DECIMAL" property="userId"></result>
        <result column="PATH_ACTIVE" jdbcType="VARCHAR" property="pathActive"></result>
        <result column="USER_VALUE" jdbcType="VARCHAR" property="userValue"></result>
        <result column="SPU_NAME" jdbcType="VARCHAR" property="spuName"></result>
        <result column="REC_PIECE_PRICE" jdbcType="VARCHAR" property="piecePrice"></result>
        <result column="JOIN_RATE" jdbcType="VARCHAR" property="joinRate"></result>
        <result column="ORDER_PERIOD" jdbcType="VARCHAR" property="orderPeriod"></result>
        <result column="REFER_DENO" jdbcType="VARCHAR" property="referDeno"></result>
        <result column="IS_PUSH" jdbcType="VARCHAR" property="isPush"></result>
        <result column="IS_CONVERSION" jdbcType="VARCHAR" property="isConversion"></result>
        <result column="PUSH_STATUS" jdbcType="VARCHAR" property="pushStatus"></result>
        <result column="SMS_CONTENT" jdbcType="VARCHAR" property="smsContent"></result>
        <result column="ACT_ORDER_PERICE" jdbcType="VARCHAR" property="actOrderPerice"></result>
        <result column="USER_PHONE" jdbcType="VARCHAR" property="userPhone"></result>
        <result column="USER_OPENID" jdbcType="VARCHAR" property="userOpenid"></result>
        <result column="TAR_PRODUCT_NUM" jdbcType="VARCHAR" property="tarProductNum"></result>
        <result column="COUPON_MIN" jdbcType="VARCHAR" property="couponMin"></result>
        <result column="COUPON_DENO" jdbcType="VARCHAR" property="couponDeno"></result>
        <result column="REC_PROD_ID" jdbcType="VARCHAR" property="recProdId"></result>
        <result column="REC_PROD_NAME" jdbcType="VARCHAR" property="recProdName"></result>
        <result column="COMPLETE_PURCH" jdbcType="VARCHAR" property="completePurch"></result>
        <result column="TAR_ORDER_PRICE" jdbcType="VARCHAR" property="tarOrderPrice"></result>
        <result column="COUPON_ID" jdbcType="DECIMAL" property="couponId"></result>
        <result column="COUPON_NAME" jdbcType="VARCHAR" property="couponName"></result>
        <result column="COUPON_URL" jdbcType="VARCHAR" property="couponUrl"></result>
    </resultMap>

    <resultMap id="effectResult" type="com.linksteady.operate.domain.DailyDetail">
        <result column="USER_ID" jdbcType="DECIMAL" property="userId"></result>
        <result column="IS_PUSH" jdbcType="VARCHAR" property="isPush"></result>
        <result column="IS_CONVERSION" jdbcType="VARCHAR" property="isConversion"></result>
        <result column="GROUP_NAME" jdbcType="VARCHAR" property="groupName"></result>
        <result column="PATH_ACTIVE" jdbcType="VARCHAR" property="pathActive"></result>
        <result column="USER_VALUE" jdbcType="VARCHAR" property="userValue"></result>
        <result column="REC_PIECE_PRICE" jdbcType="VARCHAR" property="piecePrice"></result>
        <result column="COUPON_ID" jdbcType="DECIMAL" property="couponId"></result>
        <result column="COUPON_DENOM" jdbcType="VARCHAR" property="couponDenom"></result>
        <result column="ACT_PROD_NAME" jdbcType="VARCHAR" property="actProdName"></result>
        <result column="ACT_PIECE_PERICE" jdbcType="VARCHAR" property="actPiecePrice"></result>
        <result column="IS_CANCLE" jdbcType="VARCHAR" property="isCancle"></result>
        <result column="TAR_ORDER_PRICE" jdbcType="VARCHAR" property="tarOrderPrice"></result>
        <result column="REC_PROD_NAME" jdbcType="VARCHAR" property="recProdName"></result>
    </resultMap>

    <select id="getPageList" resultMap="baseResult">
        select * from (
        select t.*, ROWNUM RN from (
        select USER_ID, SPU_NAME, COMPLETE_PURCH, TAR_ORDER_PRICE, REC_PROD_NAME, TAR_PRODUCT_NUM, USER_VALUE,
        PATH_ACTIVE
        from UO_OP_DAILY_DETAIL where head_id = #{headId}
        <if test="pathActive != '' and pathActive != null">
            and PATH_ACTIVE = #{pathActive}
        </if>
        <if test="userValue != '' and userValue != null">
            and USER_VALUE = #{userValue}
        </if>
        order by PATH_ACTIVE, USER_VALUE, DAILY_DETAIL_ID asc
        ) t where ROWNUM &lt;=#{end}
        ) where RN &gt;=#{start}
    </select>

    <select id="getDataCount" resultType="int">
        select count(1) from UO_OP_DAILY_DETAIL where head_id = #{headId}
        <if test="pathActive != '' and pathActive != null">
            and PATH_ACTIVE = #{pathActive}
        </if>
        <if test="userValue != '' and userValue != null">
            and USER_VALUE = #{userValue}
        </if>
    </select>

    <select id="getStrategyPageList" resultMap="baseResult">
        select * from (
        select t.*, ROWNUM RN from (
        select USER_ID, TAR_ORDER_PRICE, REC_PROD_NAME, REFER_DENO, ORDER_PERIOD, COUPON_MIN, COUPON_DENO, SMS_CONTENT
        from UO_OP_DAILY_DETAIL where head_id = #{headId}
        order by PATH_ACTIVE, USER_VALUE, DAILY_DETAIL_ID asc
        ) t where ROWNUM &lt;=#{end}
        ) where RN &gt;=#{start}
    </select>

    <select id="getStrategyCount" resultType="int">
        select count(1) from UO_OP_DAILY_DETAIL where head_id = #{headId}
    </select>

    <select id="getUserEffect" resultMap="effectResult">
        select * from (
        select t.*, ROWNUM RN from (
        select USER_ID, PATH_ACTIVE,IS_PUSH,IS_CONVERSION, USER_VALUE,REC_PROD_NAME, TAR_ORDER_PRICE,ACT_ORDER_PRICE
        from UO_OP_DAILY_DETAIL where head_id = #{headId}
        <if test="whereInfo != ''">
            ${whereInfo}
        </if>
        ) t where ROWNUM &lt;=#{end}
        ) where RN &gt;=#{start}
    </select>

    <select id="getDataListCount" resultType="int">
        select count(1) from UO_OP_DAILY_DETAIL t1 where head_id = #{headId}
        <if test="whereInfo != ''">
            ${whereInfo}
        </if>
    </select>

    <select id="getContentList" resultType="map">
        select DAILY_DETAIL_ID id, SMS_CONTENT content from UO_OP_DAILY_DETAIL where head_id = #{headId}
    </select>

    <update id="updatePushOrderPeriod">
        update UO_OP_DAILY_DETAIL
            <if test="pushOrderPeriod != ''">
                set PUSH_ORDER_PERIOD = #{pushOrderPeriod}
            </if>
            <if test="pushOrderPeriod == ''">
                set PUSH_ORDER_PERIOD = ORDER_PERIOD
            </if>
    </update>

    <insert id="copyToPushList">
        INSERT INTO UO_OP_PUSH_LIST(PUSH_ID,USER_PHONE,USER_OPENID,PUSH_CONTENT,PUSH_STATUS,SOURCE_CODE,SOURCE_ID,PUSH_PERIOD,IS_PUSH)
        select
               UO_OP_PUSH_LIST_SEQ.NEXTVAL,
               USER_PHONE,
               USER_OPENID,
               SMS_CONTENT,
               'P',
               'D',
               DAILY_DETAIL_ID,
               PUSH_ORDER_PERIOD,
               '0'
        FROM UO_OP_DAILY_DETAIL C
        WHERE HEAD_ID = #{headId}
    </insert>

    <select id="getUserCount" resultType="int">
        select
            count(*)
        FROM  UO_OP_DAILY_HEADER T1,
              UO_OP_DAILY_DETAIL T2
        WHERE T1.HEAD_ID=T2.HEAD_ID
          AND T1.HEAD_ID=#{headId}
    </select>

    <select id="getUserList" resultMap="baseResult">
        SELECT *
        FROM (
                 select
                     T1.HEAD_ID,
                     T2.DAILY_DETAIL_ID,
                     T2.USER_ID,
                     T2.USER_PHONE,
                     T2.USER_OPENID,
                     SMS.SMS_CONTENT,
                     T2.REC_PROD_ID,
                     T2.REC_PROD_NAME,
                     T2.COUPON_ID,
                     T2.GROWTH_STRATEGY_ID,
                     CP.COUPON_DISPLAY_NAME COUPON_NAME,
                     CP.COUPON_URL,
                     ROWNUM   RN
                 FROM UO_OP_DAILY_HEADER T1,
                      UO_OP_DAILY_DETAIL T2,
                      UO_OP_DAILY_TEMPLATE_CONFIG T3,
                      UO_OP_COUPON CP,
                      UO_OP_SMS_TEMPLATE SMS
                 WHERE T1.HEAD_ID = T2.HEAD_ID
                   AND T2.GROUP_ID = T3.GROUP_ID
                   AND T2.COUPON_ID = CP.COUPON_ID(+)
                   AND T3.SMS_CODE = SMS.SMS_CODE
                   AND T1.HEAD_ID = #{headId}
                   AND ROWNUM &lt;= #{end}
             ) WHERE RN &gt;= #{start}
    </select>

    <update id="insertPushContentTemp">
        insert into UO_OP_DAILY_CONTENT_TMP(daily_detail_id,head_id,sms_content)
        SELECT A.*
        FROM(
        <foreach collection="list" item="item" index="index"
                 separator="UNION ALL">
            SELECT
            #{item.dailyDetailId} dailyDetailId,
            #{item.headId} headId,
            #{item.smsContent} smsContent
            FROM
            dual
        </foreach>
        )A
    </update>

    <update id="synchPushStatus">
        UPDATE UO_OP_DAILY_DETAIL T
        SET (T.IS_PUSH, T.PUSH_STATUS, T.PUSH_DATE) =
            (SELECT T1.IS_PUSH, T1.PUSH_STATUS, T1.PUSH_DATE
             FROM UO_OP_PUSH_LIST T1
             WHERE T1.SOURCE_CODE = 'D'
             AND T1.SOURCE_ID = T.DAILY_DETAIL_ID)
        WHERE T.HEAD_ID IN (SELECT HEAD_ID
            FROM UO_OP_DAILY_HEADER
            WHERE TRUNC(TOUCH_DT) > TRUNC(SYSDATE - 5)
            AND STATUS IN ('done', 'finished'))

    </update>

    <delete id="deletePushContentTemp">
        delete from UO_OP_DAILY_CONTENT_TMP where head_id=#{headId}
    </delete>

    <update id="updatePushContentFromTemp">
        update UO_OP_DAILY_DETAIL set SMS_CONTENT =
            (select sms_content from UO_OP_DAILY_CONTENT_TMP where UO_OP_DAILY_CONTENT_TMP.daily_detail_id = UO_OP_DAILY_DETAIL.daily_detail_id)
        where exists
            (
                select 1 from UO_OP_DAILY_CONTENT_TMP where UO_OP_DAILY_DETAIL.daily_detail_id = UO_OP_DAILY_CONTENT_TMP.daily_detail_id
            )
    </update>
</mapper>
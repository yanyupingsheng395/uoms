<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.linksteady.operate.dao.PushListMapper">

    <resultMap id="baseResult" type="com.linksteady.operate.domain.PushListInfo">
        <result column="PUSH_ID" jdbcType="DECIMAL" property="pushId"></result>
        <result column="PUSH_CONTENT" jdbcType="VARCHAR" property="pushContent"></result>
        <result column="PUSH_PERIOD" jdbcType="VARCHAR" property="pushPeriod"></result>
        <result column="PUSH_STATUS" jdbcType="VARCHAR" property="pushStatus"></result>
        <result column="CALLBACK_ID" jdbcType="VARCHAR" property="callbackId"></result>
        <result column="CALLBACK_CODE" jdbcType="VARCHAR" property="callbackCode"></result>
        <result column="CALLBACK_DESC" jdbcType="VARCHAR" property="callbackDesc"></result>
        <result column="SOURCE_CODE" jdbcType="VARCHAR" property="sourceCode"></result>
        <result column="USER_PHONE" jdbcType="VARCHAR" property="userPhone"></result>
        <result column="USER_OPENID" jdbcType="VARCHAR" property="userOpenId"></result>
        <result column="SOURCE_ID" jdbcType="DECIMAL" property="sourceId"></result>
        <result column="PUSH_DATE" jdbcType="DATE" property="pushDate"></result>
        <result column="PUSH_DATE_STR" jdbcType="VARCHAR" property="pushDateStr"></result>
    </resultMap>

    <update id="updateSendStatus">
        <foreach collection="list" item="item" index="index" open="begin" close=";end;" separator=";">
            update UO_OP_PUSH_LIST
            <set>
                PUSH_STATUS=#{item.pushStatus},
                CALLBACK_CODE=#{item.callbackCode},
                PUSH_DATE=#{item.pushDate},
                IS_PUSH='1'
            </set>
            where PUSH_ID=#{item.pushId}
        </foreach>
    </update>

    <select id="getTotalCount" resultType="int">
        select count(1)
        FROM UO_OP_PUSH_LIST
        WHERE 1=1
        <if test="pushStatus != null and pushStatus != ''">
            and PUSH_STATUS = #{pushStatus}
        </if>
        <if test="sourceCode != null and sourceCode != ''">
            and SOURCE_CODE = #{sourceCode}
        </if>
        <if test="pushDateStr != null and pushDateStr != ''">
            and trunc(PUSH_DATE, 'dd') = to_date(#{pushDateStr}, 'yyyymmdd')
        </if>
    </select>

    <select id="getPushInfoListPage" resultMap="baseResult">
        select * from (
        select t.*, ROWNUM rn from (
        select PUSH_ID,
        PUSH_CONTENT,
        PUSH_PERIOD,
        PUSH_STATUS,
        CALLBACK_ID,
        CALLBACK_CODE,
        CALLBACK_DESC,
        SOURCE_CODE,
        USER_PHONE,
        USER_OPENID,
        SOURCE_ID,
        to_char(PUSH_DATE, 'yyyymmdd') PUSH_DATE_STR
        FROM UO_OP_PUSH_LIST
        WHERE 1=1
        <if test="pushStatus != null and pushStatus != ''">
            and PUSH_STATUS = #{pushStatus}
        </if>
        <if test="sourceCode != null and sourceCode != ''">
            and SOURCE_CODE = #{sourceCode}
        </if>
        <if test="pushDateStr != null and pushDateStr != ''">
            and trunc(PUSH_DATE, 'dd') = to_date(#{pushDateStr}, 'yyyymmdd')
        </if>
        order by PUSH_ID desc
        ) t where ROWNUM &lt;= #{end}
        )where rn &gt;= #{start}
    </select>

    <insert id="insertTestMsg">
        <selectKey resultType="java.lang.Long" keyProperty="pushId" order="BEFORE" >
            SELECT UO_OP_PUSH_LIST_SEQ.NEXTVAL from DUAL
        </selectKey>

        INSERT INTO UO_OP_PUSH_LIST(PUSH_ID,USER_PHONE,USER_OPENID,PUSH_CONTENT,PUSH_STATUS,SOURCE_CODE,SOURCE_ID,PUSH_PERIOD,IS_PUSH)
        values(
            #{pushId},
            #{userPhone},
            NULL,
            #{pushContent},
            'S',
            'T',
            #{pushId},
            #{pushPeriod},
            '1')
    </insert>
</mapper>
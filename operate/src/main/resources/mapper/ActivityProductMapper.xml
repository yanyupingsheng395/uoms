<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.linksteady.operate.dao.ActivityProductMapper">

    <resultMap id="base" type="com.linksteady.operate.domain.ActivityProduct">
        <result property="headId" jdbcType="DECIMAL" column="HEAD_ID"></result>
        <result property="productId" jdbcType="DECIMAL" column="PRODUCT_ID"></result>
        <result property="userCount" jdbcType="DECIMAL" column="USER_COUNT"></result>
        <result property="productPrice" jdbcType="DECIMAL" column="PRODUCT_PRICE"></result>
        <result property="preferType" jdbcType="VARCHAR" column="PREFER_TYPE"></result>
        <result property="preferValue" jdbcType="VARCHAR" column="PREFER_VALUE"></result>
        <result property="minPrice15" jdbcType="DECIMAL" column="MIN_PRICE15"></result>
        <result property="minPrice30" jdbcType="DECIMAL" column="MIN_PRICE30"></result>
        <result property="productActPrice" jdbcType="DECIMAL" column="PRODUCT_ACT_PRICE"></result>
    </resultMap>

    <select id="getActivityProductListPage" resultMap="base">
        select * from (
        select t.*, ROWNUM rn from (
          select head_id, product_id, user_count, product_price, prefer_type, prefer_value, min_price15, min_price30, PRODUCT_ACT_PRICE from UO_OP_ACTIVITY_PRODUCT
          where HEAD_ID = #{headId}
        order by user_count desc
        ) t where ROWNUM &lt;=#{end}
        ) where RN &gt;= #{start}
    </select>

    <select id="getCount" resultType="int">
        select count(1) from UO_OP_ACTIVITY_PRODUCT where HEAD_ID = #{headId}
    </select>

    <insert id="saveDataList">
        insert into UO_OP_ACTIVITY_PRODUCT(head_id, product_id, user_count, product_price, prefer_type, prefer_value,
        product_act_price, min_price15, min_price30)
        <foreach item="item"  collection="list" index="index" separator="union all">
            select #{item.headId}, #{item.productId},#{item.userCount},#{item.productPrice},#{item.preferType},#{item.preferValue},#{item.productActPrice},
            #{item.minPrice15}, #{item.minPrice30} from dual
        </foreach>
    </insert>

    <insert id="insertProductList">
        insert into UO_OP_ACTIVITY_PRODUCT(head_id, product_id, user_count, product_price, prefer_value,
        product_act_price, min_price15, min_price30, prefer_type)
        select head_id,
        product_id,
        user_count,
        product_price,
        prefer_value,
        product_act_price,
        min_price15,
        min_price30,
        prefer_type
        from (select
        #{headId} head_id,
        REC_PROD_ID product_id,
        count(1) user_count,
        max(o.price) product_price,
        TRUNC(avg(refer_deno), 2) prefer_value,
        (max(o.price) - TRUNC(avg(refer_deno), 2)) product_act_price,
        w.FIFTEEN_LOWERST_PRICE min_price15,
        w.THIRTY_LOWERST_PRICE min_price30,
        case
        when (max(o.price) - TRUNC(avg(refer_deno), 2)) &lt;= 100 then
        'promote'
        else (case
        when max(o.price) &lt;= 370 then
        'discount'
        when max(o.PRICE) &gt; 370 then
        'reduce' end) end prefer_type
        from UO_OP_ACTIVITY_OPTION o,
        W_PRODUCT w
        where ((TOUCH_DT &lt;= to_date(#{startDate}, 'yyyy-mm-dd') and
        TOUCH_DT &lt;= to_date(#{endDate}, 'yyyy-mm-dd')) or (
        data_type = '2' and REMAIN_TIME &lt;= #{dayPeriod} + 90
        ))
        and o.rec_prod_id = w.product_id(+)
        group by rec_prod_id, w.FIFTEEN_LOWERST_PRICE, w.THIRTY_LOWERST_PRICE)
    </insert>

    <delete id="deleteByHeadId">
        delete from UO_OP_ACTIVITY_PRODUCT where head_id = #{headId}
    </delete>
</mapper>
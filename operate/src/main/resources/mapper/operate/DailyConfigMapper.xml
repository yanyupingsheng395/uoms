<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.linksteady.operate.dao.DailyConfigMapper">
    <update id="updateCheckFlagY">
        update UO_OP_DAILY_TEMPLATE_CONFIG set CHECK_FLAG = 'Y', CHECK_COMMENTS = ''
    </update>

    <update id="updateCheckFlagAndRemark">
        update uo_op_daily_template_config set check_flag = 'N', check_comments = #{remark}
        where group_id in (
            select distinct t1.group_id
            from uo_op_daily_template_config t1
                  left join uo_op_sms_template t2 on t1.sms_code = t2.sms_code
                  left join  uo_op_daily_group_coupon t3 on t1.group_id = t3.group_id
                  left join uo_op_coupon t4 on t3.coupon_id = t4.coupon_id
                  where 1=1
               ${whereInfo}
        )
    </update>

    <select id="validCheckedUserGroup" resultType="int">
        select count(1) from UO_OP_DAILY_TEMPLATE_CONFIG where CHECK_FLAG = 'N' and PATH_ACTIVE in
        <foreach collection="activeList" open="(" close=")" item="item" separator=",">
            #{item}
        </foreach>
    </select>

    <update id="deleteSmsGroup">
        update UO_OP_DAILY_TEMPLATE_CONFIG set SMS_CODE = null  where GROUP_ID in
        <foreach collection="list" separator="," open="(" close=")" item="item">
            #{item}::int4
        </foreach>
    </update>

    <update id="updateWxMsgId">
        update uo_op_daily_template_config t1
        set qywx_id = #{qywxId}::integer
        where group_id in (
            select t1.group_id
            from uo_op_daily_template_config t1,
                 uo_op_daily_template_config t2
            where t1.user_value = t2.user_value
              and t1.lifecycle = t2.lifecycle
              and t1.path_active = t2.path_active and t2.group_id = #{groupId}::integer)
    </update>

    <select id="findMsgInfo" resultType="map">
        select uost.sms_content duanxin, uqmt.text_content weixin from uo_op_daily_template_config t1
            left join uo_op_sms_template uost on t1.sms_code = uost.sms_code
            left join uo_qywx_msg_template uqmt on t1.qywx_id = uqmt.qywx_id
        where t1.user_value = #{userValue} and t1.lifecycle = #{lifeCycle} and t1.path_active = #{pathActive} and t1.tar_type = #{tarType}
    </select>
</mapper>
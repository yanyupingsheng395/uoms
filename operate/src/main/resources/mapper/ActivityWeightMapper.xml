<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.linksteady.operate.dao.ActivityWeightMapper">

    <resultMap id="baseResult" type="com.linksteady.operate.domain.ActivityWeight">
        <result property="weightIdx" jdbcType="DECIMAL" column="WEIGHT_IDX"></result>
        <result property="activDtStr" jdbcType="VARCHAR" column="ACTIV_DT_STR"></result>
        <result property="activDt" jdbcType="DATE" column="ACTIV_DT"></result>
    </resultMap>

    <select id="getWeightIdx" resultType="map">
        select WEIGHT_IDX, to_char(ACTIV_DT, 'yyyyMMdd') DT from UO_OP_ACTIVITY_WEIGHT
        where 1=1
        <if test="startDt != '' and startDt != null">
            and ACTIV_DT &gt;= to_date(#{startDt}, 'yyyy-MM-dd')
        </if>
        <if test="endDt != '' and endDt != null">
            and ACTIV_DT &lt;= to_date(#{endDt}, 'yyyy-MM-dd')
        </if>
        order by ACTIV_DT asc
    </select>

    <select id="getTop5weightForBegin" resultMap="baseResult">
        SELECT ACTIV_DT_STR, WEIGHT_IDX,ACTIV_DT FROM(
            SELECT ACTIV_DT_STR, WEIGHT_IDX,ACTIV_DT
            FROM (SELECT TO_CHAR(T.ACTIV_DT, 'YYYYMMDD') ACTIV_DT_STR, WEIGHT_IDX,T.ACTIV_DT
            FROM UO_OP_ACTIVITY_WEIGHT T
            WHERE T.ACTIV_DT &lt; to_date(#{beginDate},'YYYY-MM-DD')
            ORDER BY T.ACTIV_DT desc)
            WHERE ROWNUM &lt;= 5) ORDER BY ACTIV_DT_STR ASC
    </select>

    <select id="getTop8weightForBegin" resultMap="baseResult">
        SELECT ACTIV_DT_STR, WEIGHT_IDX,ACTIV_DT FROM(
               SELECT ROWNUM RN,ACTIV_DT_STR, WEIGHT_IDX,ACTIV_DT
               FROM (SELECT TO_CHAR(T.ACTIV_DT, 'YYYYMMDD') ACTIV_DT_STR, WEIGHT_IDX,T.ACTIV_DT
                     FROM UO_OP_ACTIVITY_WEIGHT T
                     WHERE T.ACTIV_DT &lt; to_date(#{beginDate},'YYYY-MM-DD')
                     ORDER BY T.ACTIV_DT desc)
               WHERE ROWNUM &lt;= 8) WHERE RN &gt;5 ORDER BY ACTIV_DT_STR ASC
    </select>

    <select id="getEffectDateForEnd" resultMap="baseResult">
        SELECT * FROM (
        SELECT TO_CHAR(T.ACTIV_DT, 'YYYYMMDD') ACTIV_DT_STR, WEIGHT_IDX,T.ACTIV_DT
        FROM UO_OP_ACTIVITY_WEIGHT T
        WHERE
        trunc(T.ACTIV_DT) &gt;(
        SELECT TRUNC(MIN(T1.ACTIV_DT))
        FROM UO_OP_ACTIVITY_WEIGHT T1
        WHERE T1.ACTIV_DT &gt;to_date(#{endDate},'YYYY-MM-DD')
        AND T1.WEIGHT_IDX &lt;1
        )
        AND T.WEIGHT_IDX&gt; =1 order by ACTIV_DT_STR ASC ) WHERE ROWNUM=1
    </select>
</mapper>
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.linksteady.qywx.dao.UserTaskMapper">

    <select id="getUserTodayStatus" resultType="map">
        with v1 as (
            select t1.rn, t1.spu_wid
            from wp_user_path t1,
                 (select max(rn) rn from wp_user_path where ebp_product_id = #{productId}::int8 and user_id = #{userId}::integer) t2
            where ebp_product_id = #{productId}::int8
              and user_id = #{userId}::integer
              and t1.rn = t2.rn
        )
        select active_type, active_dual, trunc(prob * 100, 2) prob, dual_begin, dual_end, v1.rn
        from wp_purchase_prob t1,
             v1
        where t1.spu_wid = v1.spu_wid
          and t1.rn = v1.rn
          and is_spu = '1'
        order by active_dual asc
    </select>

    <select id="getUserLastBuyDt" resultType="string">
        select ORDER_DT_WID from WP_USER_PATH t0, (select max(rn) max_rn from WP_USER_PATH where USER_ID = #{userId}::integer and ebp_product_id = #{productId}::int8) t1
        where USER_ID = #{userId}::integer and ebp_product_id = #{productId}::int8 and t0.rn = t1.max_rn
    </select>

    <select id="getUserTimes" resultType="map">
        select week_day, time_slot from wp_insight_user_timeslot where user_id = #{userId}::integer order by week_day asc
    </select>

    <select id="getCouponListOfProduct" resultType="map">
        select coupon_id, coupon_deno, coupon_min, coupon_url, epb_product_name, to_char(coupon_valid_end, 'yyyymmdd') coupon_valid_end from wp_insight_user_assist where user_id = #{userId}::integer order by priority_no asc
    </select>

    <select id="getProductData" resultType="map">
        select epb_product_id, epb_product_name, priority_no, price, purch_probability, epb_product_url from wp_insight_user_assist where user_id = #{userId}::integer
    </select>

    <select id="getUserBuyHistory" resultType="map">
        select user_id, to_char(order_dt, 'yyyy年mm月dd日 hh24:mi') order_dt, spu_name, product_name, order_fee, interval_days
        from wp_insight_user_orderseries where user_id = #{userId}::integer order by order_dt desc
    </select>
</mapper>
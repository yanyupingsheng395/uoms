<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.linksteady.qywx.dao.UserTaskMapper">
    <resultMap id="userBuyHistoryMap" type="com.linksteady.qywx.domain.UserBuyHistory">
        <result column="user_id" jdbcType="VARCHAR" property="userId"/>
        <result column="order_dt" jdbcType="VARCHAR" property="orderDt"/>
        <result column="spu_id" jdbcType="DECIMAL" property="spuId"/>
        <result column="spu_name" jdbcType="VARCHAR" property="spuName"/>
        <result column="product_name" jdbcType="VARCHAR" property="productName"/>
        <result column="order_fee" jdbcType="DECIMAL" property="orderFee"/>
        <result column="interval_days" jdbcType="DECIMAL" property="intervalDays"/>
    </resultMap>

    <resultMap id="spuInfoMap" type="com.linksteady.qywx.domain.SpuInfo">
        <result column="spu_id" jdbcType="VARCHAR" property="spuId"/>
        <result column="spu_name" jdbcType="VARCHAR" property="spuName"/>
    </resultMap>

    <select id="getUserTodayStatus" resultType="map">
        with v1 as (
            select t1.rn, t1.spu_wid
            from wp_user_path t1,
                 (select max(rn) rn from wp_user_path where ebp_product_id = #{productId}::int8 and user_id = #{userId}::integer) t2
            where ebp_product_id = #{productId}::int8
              and user_id = #{userId}::integer
              and t1.rn = t2.rn
        )
        select active_type, active_dual, trunc(prob * 100, 2) prob, dual_begin, dual_end, v1.rn
        from wp_purchase_prob t1,
             v1
        where t1.spu_wid = v1.spu_wid
          and t1.rn = v1.rn
          and is_spu = '1'
        order by active_dual asc
    </select>

    <select id="getUserLastBuyDt" resultType="string">
        select ORDER_DT_WID from WP_USER_PATH t0, (select max(rn) max_rn from WP_USER_PATH where USER_ID = #{userId}::integer and ebp_product_id = #{productId}::int8) t1
        where USER_ID = #{userId}::integer and ebp_product_id = #{productId}::int8 and t0.rn = t1.max_rn
    </select>

    <select id="getUserTimes" resultType="map">
        select week_day, time_slot from wp_insight_user_timeslot where user_id = #{userId}::integer order by week_day asc
    </select>

    <select id="getCouponListOfProduct" resultType="map">
        select coupon_id, coupon_deno, coupon_min, coupon_url, epb_product_name, to_char(coupon_valid_end, 'yyyymmdd') coupon_valid_end from wp_insight_user_assist where user_id = #{userId}::integer and epb_product_id = #{productId}::bigint order by priority_no asc
    </select>

    <select id="getProductData" resultType="map">
        select epb_product_id, epb_product_name, priority_no, price, purch_probability, epb_product_url from wp_insight_user_assist where user_id = #{userId}::integer
    </select>

    <select id="getUserBuyHistory" resultMap="userBuyHistoryMap">
        select user_id,
               to_char(order_dt, 'yyyy年mm月dd日 hh24:mi') order_dt,
               spu_id,
               spu_name,
               product_name,
               order_fee,
               interval_days
        from wp_insight_user_orderseries
        where user_id = #{userId}::integer
        order by order_dt desc
    </select>

    <select id="getSpuList" resultMap="spuInfoMap">
         select distinct
               spu_id,
               spu_name
        from wp_insight_user_orderseries
        where user_id = #{userId}::integer
        order by spu_id desc
    </select>
</mapper>
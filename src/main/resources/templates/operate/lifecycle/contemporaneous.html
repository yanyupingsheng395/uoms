<div class="row">
    <div class="col-md-12">
        <h5>同期群分析留存/流失</h5>
        <hr style="margin-top:5px; margin-bottom: 5px;"/>
        <form class="form-inline pull-left" action="" method="post" onsubmit="return false;">
            <div class="form-group">
                <input class="form-control js-datepicker m-b-10" type="text" id="startDate_1" name="startDate" data-date-format="yyyy-mm"/>
            </div>
            <div class="form-group">
                <button class="btn btn-primary m-b-10" type="button" onclick="searchData()"><i class="mdi mdi-magnify"></i>查询</button>
            </div>
        </form>
        <div class="pull-right">
            <div class="btn-group-round" id="cohortbtngroup1">
                <button class="btn btn-primary btn-sm btn-round cohortbtn" name="month">自然月</button>
                <button class="btn btn-default btn-sm btn-round cohortbtn" name="dmonth">间隔月</button>
            </div>
        </div>
        <ul class="nav nav-tabs" style="clear: both;" id="tabs02">
            <li class="active"> <a data-toggle="tab" href="#retain" onclick="tabClick(1)">留存率</a> </li>
            <li> <a data-toggle="tab" href="#retain_cnt" onclick="tabClick(2)"> 留存用户数</a> </li>
            <li> <a data-toggle="tab" href="#loss" onclick="tabClick(3)">流失率</a> </li>
            <li> <a data-toggle="tab" href="#loss_cnt" onclick="tabClick(4)">流失用户数</a> </li>
        </ul>
        <div class="tab-content">
            <div class="tab-pane fade active in table-responsive" id="retain">
                <table data-show-columns="false" class="table table-hover table-bordered table-striped table-condensed text-nowrap" id="dataTable1" style="word-break: break-all; word-wrap: break-word;max-height: 400px;overflow:scroll;height: auto;"></table>
            </div>

            <div class="tab-pane fade table-responsive" id="retain_cnt">
                <table data-show-columns="false" class="table table-hover table-bordered table-striped table-condensed text-nowrap" id="dataTable2" style="word-break: break-all; word-wrap: break-word;max-height: 400px;overflow:scroll;height: auto;"></table>
            </div>

            <div class="tab-pane fade table-responsive" id="loss">
                <table data-show-columns="false" class="table table-hover table-bordered table-striped table-condensed text-nowrap" id="dataTable3" style="word-break: break-all; word-wrap: break-word;height: auto;"></table>
            </div>

            <div class="tab-pane fade table-responsivetable-responsive" id="loss_cnt">
                <table data-show-columns="false" class="table table-hover table-bordered table-striped table-condensed text-nowrap" id="dataTable4" style="word-break: break-all; word-wrap: break-word;height: auto;"></table>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        var date = new Date();
        date.setMonth(date.getMonth()-12);
        var month = "";
        if(date.getMonth() < 9) {
            month = "0" + (date.getMonth() + 1);
        }else {
            month = date.getMonth() + 1;
        }
        $("#startDate_1").val(date.getFullYear() + "-" + month);
    });

    function searchData() {
        $("#tabs02").find("li[class='active']").find("a").click();
    }

    function tabClick(idx) {
        getData(idx);
    }

    // 获取表格数据
    function getData(idx) {
        lightyear.loading('show');
        var url = "";
        if(idx == 1) {
            url = "/kpiMonitor/getRetentionBySpu";
        }else if(idx == 2) {
            url = "/kpiMonitor/getRetainUserCountBySpu"
        }else if(idx == 3) {
            url = "/kpiMonitor/getLossUserRateBySpu"
        }else if(idx == 4) {
            url = "/kpiMonitor/getLossUserBySpu"
        }
        var $table = $('#dataTable' + idx);
        var spuId = selectId;
        var startDt = $("#startDate_1").val();
        var periodType=$("#cohortbtngroup1>.btn-primary:first").attr("name");
        $.get(url, {spuId: spuId, startDt: startDt, periodType:periodType}, function(r) {
            var columns = new Array();
            var percent = false;
            if(idx == 1 || idx == 3) {
                percent = true;
            }
            if(periodType == "dmonth") {
                columns = getDMonthCols(percent);
            }else if(periodType == "month"){
                columns = getMonthCols(r.data.columns, percent);
            }
            var data = r.data.data;
            initBootstrapTable($table, columns, data);
        });
    }

    $("#cohortbtngroup1>.cohortbtn").on('click',function () {
        if(!$(this).hasClass("btn-primary")) {
            $(this).removeClass("btn-default").addClass("btn-primary");
            $(this).siblings().removeClass("btn-primary").addClass("btn-default");
        }
        $("#tabs02").find("li[class='active']").find("a").click();
    });


    // 留存率间隔月
    function getDMonthCols(percent) {
        var fix = "";
        if(percent) {
            fix = "%";
        }else {
            fix = "";
        }
        var cols = [
            {field: 'MONTH_ID', title: '月份'},
            {field: 'TOTAL_USER', title: '本月新增用户数', width: '132px'},
            {field: 'MONTH1', title: '+1月', formatter: function (value, row, index) {if(value == "0") {return "";}else {return value + fix;}}},
            {field: 'MONTH2', title: '+2月', formatter: function (value, row, index) {if(value == "0") {return "";}else {return value + fix;}}},
            {field: 'MONTH3', title: '+3月', formatter: function (value, row, index) {if(value == "0") {return "";}else {return value + fix;}}},
            {field: 'MONTH4', title: '+4月', formatter: function (value, row, index) {if(value == "0") {return "";}else {return value + fix;}}},
            {field: 'MONTH5', title: '+5月', formatter: function (value, row, index) {if(value == "0") {return "";}else {return value + fix;}}},
            {field: 'MONTH6', title: '+6月', formatter: function (value, row, index) {if(value == "0") {return "";}else {return value + fix;}}},
            {field: 'MONTH7', title: '+7月', formatter: function (value, row, index) {if(value == "0") {return "";}else {return value + fix;}}},
            {field: 'MONTH8', title: '+8月', formatter: function (value, row, index) {if(value == "0") {return "";}else {return value + fix;}}},
            {field: 'MONTH9', title: '+9月', formatter: function (value, row, index) {if(value == "0") {return "";}else {return value + fix;}}},
            {field: 'MONTH10', title: '+10月', formatter: function (value, row, index) {if(value == "0") {return "";}else {return value + fix;}}},
            {field: 'MONTH11', title: '+11月', formatter: function (value, row, index) {if(value == "0") {return "";}else {return value + fix;}}},
            {field: 'MONTH12', title: '+12月', formatter: function (value, row, index) {if(value == "0") {return "";}else {return value + fix;}}},
        ];
        return cols;
    }

    // 留存率自然月
    function getMonthCols(data, percent) {
        var cols = [];
        $.each(data, function (k, v) {
            var o = new Object();
            o.field = v;
            if(v == "month") {
                o.title = "月份";
            }else if(v == "newUsers"){
                o.title = "本月新增用户数";
                o.width = "132px";
            }else {
                o.title = v;
            }
            o.formatter = function (value, row, index) {
                if (value == "0" || value == null) {
                    return "";
                } else {
                    var fix;
                    if(percent) {
                        fix = "%";
                    }else {
                        fix = "";
                    }
                    if(v != "month" && v != "newUsers") {
                        return value + fix;
                    }else {
                        return value;
                    }
                }
            };
            cols.push(o);
        });
        return cols;
    }

    /**
     * 数据量小会出现表头重叠，否则不出现。通过data.length判断解决
     * @param $el
     * @param columns
     * @param data
     * @param total
     * @param periodType
     */
    // 初始化dataTable
    function initBootstrapTable($el, columns, data) {
        var option = {
            columns: columns,
            data: data,
            search: false,
        };
        $el.bootstrapTable('destroy').bootstrapTable(option);
        lightyear.loading('hide');
    }
</script>